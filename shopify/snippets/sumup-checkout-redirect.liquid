{% comment %}
  SumUp Checkout Redirect Snippet
  
  This snippet intercepts the Shopify checkout "Complete order" button
  and redirects to SumUp payment instead of processing through Shopify.
  
  Place this in checkout.liquid or checkout template.
  
  Usage:
  {% render 'sumup-checkout-redirect' %}
  
  Or with custom backend URL:
  {% render 'sumup-checkout-redirect', backend_url: 'https://your-backend-url.com' %}
{% endcomment %}

{%- liquid
  assign backend_url = backend_url | default: settings.sumup_backend_url | default: 'https://sumup-shopify-backend.onrender.com'
-%}

<script>
(function() {
  'use strict';
  
  console.log('SumUp: Checkout redirect script loaded');
  
  const BACKEND_URL = '{{ backend_url }}';
  let isProcessing = false;
  
  // Get checkout total from page
  function getCheckoutTotal() {
    // Try multiple selectors to find total
    const totalSelectors = [
      '[data-checkout-payment-due-target]',
      '[data-total-price]',
      '.total-line__price',
      '.order-summary__section--total .order-summary__emphasis',
      '.total-recap__final-price',
      '.payment-due__price',
      '.total-line-table__footer .total-line__price'
    ];
    
    for (const selector of totalSelectors) {
      const element = document.querySelector(selector);
      if (element) {
        const text = element.textContent || element.innerText;
        // Extract number from text (remove currency symbols, spaces, etc.)
        const match = text.match(/[\d,]+\.?\d*/);
        if (match) {
          const amount = parseFloat(match[0].replace(/,/g, ''));
          return Math.round(amount * 100); // Convert to cents
        }
      }
    }
    
    // Fallback: try to get from checkout object
    if (window.Shopify && window.Shopify.checkout) {
      const total = window.Shopify.checkout.total_price;
      if (total) {
        return Math.round(total / 100); // Shopify stores in cents, but we need to verify
      }
    }
    
    console.warn('SumUp: Could not find checkout total');
    return null;
  }
  
  // Get currency
  function getCurrency() {
    if (window.Shopify && window.Shopify.checkout) {
      return window.Shopify.checkout.currency || 'EUR';
    }
    return 'EUR';
  }
  
  // Get order ID if available
  function getOrderId() {
    if (window.Shopify && window.Shopify.checkout) {
      return window.Shopify.checkout.order_id || null;
    }
    return null;
  }
  
  // Get return URL (thank you page)
  function getReturnUrl() {
    const hostname = window.location.hostname;
    const protocol = window.location.protocol;
    return `${protocol}//${hostname}/checkout/thank_you`;
  }
  
  // Show error message
  function showError(message) {
    console.error('SumUp Error:', message);
    
    // Try to find error container or create one
    let errorDiv = document.getElementById('sumup-checkout-error');
    if (!errorDiv) {
      errorDiv = document.createElement('div');
      errorDiv.id = 'sumup-checkout-error';
      errorDiv.style.cssText = 'margin: 15px 0; padding: 15px; background-color: #fee; border: 1px solid #fcc; border-radius: 4px; color: #c33; font-size: 14px;';
      
      // Try to insert before submit button
      const submitButton = findSubmitButton();
      if (submitButton && submitButton.parentElement) {
        submitButton.parentElement.insertBefore(errorDiv, submitButton);
      } else {
        document.body.insertBefore(errorDiv, document.body.firstChild);
      }
    }
    
    errorDiv.textContent = message;
    errorDiv.style.display = 'block';
    
    // Hide after 10 seconds
    setTimeout(() => {
      errorDiv.style.display = 'none';
    }, 10000);
  }
  
  // Find the submit/complete order button
  function findSubmitButton() {
    const selectors = [
      'button[type="submit"]',
      'input[type="submit"]',
      'button[name="complete"]',
      '[data-complete-order-button]',
      '.step__footer__continue-btn',
      '.order-summary__section .btn',
      'button.btn--primary',
      '.payment-button',
      'button:contains("Complete order")',
      'button:contains("Bestelling voltooien")',
      'button:contains("Afrekenen")'
    ];
    
    for (const selector of selectors) {
      const buttons = document.querySelectorAll(selector);
      for (const button of buttons) {
        const text = (button.textContent || button.innerText || '').toLowerCase();
        if (text.includes('complete') || 
            text.includes('order') || 
            text.includes('voltooien') || 
            text.includes('afrekenen') ||
            text.includes('pay') ||
            text.includes('betalen')) {
          return button;
        }
      }
    }
    
    // Fallback: find any submit button in a form
    const forms = document.querySelectorAll('form');
    for (const form of forms) {
      const submitBtn = form.querySelector('button[type="submit"], input[type="submit"]');
      if (submitBtn) {
        return submitBtn;
      }
    }
    
    return null;
  }
  
  // Create SumUp checkout and redirect
  async function redirectToSumUp(event) {
    if (isProcessing) {
      console.log('SumUp: Already processing, ignoring click');
      event.preventDefault();
      event.stopPropagation();
      event.stopImmediatePropagation();
      return false;
    }
    
    // AGGRESSIVELY prevent default behavior
    if (event) {
      event.preventDefault();
      event.stopPropagation();
      event.stopImmediatePropagation();
      event.stopImmediatePropagation();
    }
    
    isProcessing = true;
    console.log('SumUp: Processing started, preventing form submission');
    
    const submitButton = findSubmitButton();
    if (submitButton) {
      submitButton.disabled = true;
      const originalText = submitButton.textContent || submitButton.innerText;
      submitButton.textContent = 'Processing...';
    }
    
    try {
      const amount = getCheckoutTotal();
      if (!amount || amount <= 0) {
        throw new Error('Could not determine checkout total. Please refresh and try again.');
      }
      
      const currency = getCurrency();
      const orderId = getOrderId();
      const returnUrl = getReturnUrl();
      
      console.log('SumUp: Creating checkout with:', {
        amount,
        currency,
        orderId,
        returnUrl
      });
      
      const payload = {
        amount: amount,
        currency: currency,
        description: orderId ? `Shopify Order #${orderId}` : 'Shopify Checkout Payment',
        order_id: orderId,
        redirect_url: returnUrl
      };
      
      const response = await fetch(`${BACKEND_URL}/create-checkout`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(payload)
      });
      
      const data = await response.json();
      
      if (!response.ok) {
        throw new Error(data.error || `Server error: ${response.status}`);
      }
      
      if (data.success && data.checkout_url) {
        console.log('SumUp: Checkout created, redirecting to:', data.checkout_url);
        // CRITICAL: Stop all processing and redirect immediately
        isProcessing = true;
        // Redirect to SumUp payment page
        window.location.replace(data.checkout_url);
        // Also try href as backup
        setTimeout(() => {
          window.location.href = data.checkout_url;
        }, 100);
        return false;
      } else {
        throw new Error(data.error || 'Invalid response from server');
      }
      
    } catch (error) {
      console.error('SumUp: Error creating checkout:', error);
      
      let errorMessage = error.message || 'Failed to create payment session. Please try again.';
      
      if (errorMessage.includes('Unknown client')) {
        errorMessage = 'Payment service configuration error. Please contact store support.';
      }
      
      showError(errorMessage);
      
      // Re-enable button
      if (submitButton) {
        submitButton.disabled = false;
        submitButton.textContent = originalText || 'Complete order';
      }
      
      isProcessing = false;
      
      // CRITICAL: Prevent any further form submission
      if (event) {
        event.preventDefault();
        event.stopPropagation();
        event.stopImmediatePropagation();
      }
    }
    
    // ALWAYS return false to prevent default
    return false;
  }
  
  // Initialize
  function init() {
    console.log('SumUp: Initializing checkout redirect...');
    
    // Wait for page to fully load
    const initCheckout = () => {
      const submitButton = findSubmitButton();
      
      if (submitButton) {
        console.log('SumUp: Found submit button, attaching handler');
        
        // Prevent form submission - MULTIPLE METHODS
        const form = submitButton.closest('form');
        if (form) {
          // Method 1: Add submit listener with capture
          form.addEventListener('submit', function(e) {
            console.log('SumUp: Form submit intercepted!');
            e.preventDefault();
            e.stopPropagation();
            e.stopImmediatePropagation();
            redirectToSumUp(e);
            return false;
          }, true);
          
          // Method 2: Override submit function
          const originalSubmit = form.submit;
          form.submit = function() {
            console.log('SumUp: Form.submit() intercepted!');
            redirectToSumUp(new Event('submit'));
            return false;
          };
          
          console.log('SumUp: Form submit handler attached (multiple methods)');
        }
        
        // Also handle button click directly - MULTIPLE METHODS
        submitButton.addEventListener('click', function(e) {
          console.log('SumUp: Button click intercepted!');
          e.preventDefault();
          e.stopPropagation();
          e.stopImmediatePropagation();
          redirectToSumUp(e);
          return false;
        }, true);
        
        // Also use onclick (as backup)
        const originalOnClick = submitButton.onclick;
        submitButton.onclick = function(e) {
          console.log('SumUp: Button onclick intercepted!');
          if (e) {
            e.preventDefault();
            e.stopPropagation();
          }
          redirectToSumUp(e || new Event('click'));
          return false;
        };
        
        console.log('SumUp: Button click handler attached (multiple methods)');
        
      } else {
        console.warn('SumUp: Submit button not found, retrying...');
        // Retry after a delay
        setTimeout(initCheckout, 500);
      }
    };
    
    // Start initialization
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initCheckout);
    } else {
      // DOM already ready, but wait a bit for dynamic content
      setTimeout(initCheckout, 100);
    }
  }
  
  // CRITICAL: Prevent navigation to thank you page
  window.addEventListener('beforeunload', function(e) {
    if (isProcessing) {
      // Don't allow navigation while processing
      e.preventDefault();
      e.returnValue = '';
      return '';
    }
  });
  
  // Also intercept any navigation attempts
  const originalPushState = history.pushState;
  history.pushState = function() {
    if (!isProcessing) {
      originalPushState.apply(history, arguments);
    } else {
      console.log('SumUp: Blocked navigation while processing');
    }
  };
  
  // Start
  init();
  
})();
</script>

