{% comment %}
  SumUp Payment Widget Integration
  
  This uses SumUp's Payment Widget (embedded) instead of redirect.
  Creates a checkout and mounts the payment widget on the page.
  
  Usage:
  {% render 'sumup-payment-widget' %}
  
  Or with custom backend URL:
  {% render 'sumup-payment-widget', backend_url: 'https://your-backend-url.com' %}
{% endcomment %}

{%- liquid
  assign backend_url = backend_url | default: settings.sumup_backend_url | default: 'https://sumup-shopify-backend.onrender.com'
-%}

<div id="sumup-payment-widget-container" style="margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; background: #fff;">
  <h3 style="margin-top: 0;">Pay with SumUp</h3>
  <div id="sumup-card"></div>
  <div id="sumup-error-message" style="display: none; margin-top: 15px; padding: 15px; background-color: #fee; border: 1px solid #fcc; border-radius: 4px; color: #c33;"></div>
  <div id="sumup-loading" style="text-align: center; padding: 20px;">
    <p>Loading payment form...</p>
  </div>
</div>

<style>
  /* Hide Shopify's default checkout button when SumUp widget is active */
  #sumup-payment-widget-container:not(:empty) ~ form button[type="submit"],
  #sumup-payment-widget-container:not(:empty) ~ * form button[type="submit"],
  #sumup-payment-widget-container:not(:empty) ~ * button[name="complete"],
  #sumup-payment-widget-container:not(:empty) ~ * [data-complete-order-button] {
    display: none !important;
  }
  
  /* Also hide if widget container exists */
  body:has(#sumup-payment-widget-container) form button[type="submit"],
  body:has(#sumup-payment-widget-container) button[name="complete"],
  body:has(#sumup-payment-widget-container) [data-complete-order-button] {
    display: none !important;
  }
</style>

<script src="https://gateway.sumup.com/gateway/ecom/card/v2/sdk.js"></script>
<script>
(function() {
  'use strict';
  
  console.log('SumUp: Payment Widget script loaded');
  
  const BACKEND_URL = '{{ backend_url }}';
  let sumupCardInstance = null;
  let isProcessing = false;
  
  // Get checkout total from page
  function getCheckoutTotal() {
    const totalSelectors = [
      '[data-checkout-payment-due-target]',
      '[data-total-price]',
      '.total-line__price',
      '.order-summary__section--total .order-summary__emphasis',
      '.total-recap__final-price',
      '.payment-due__price',
      '.total-line-table__footer .total-line__price'
    ];
    
    for (const selector of totalSelectors) {
      const element = document.querySelector(selector);
      if (element) {
        const text = element.textContent || element.innerText;
        const match = text.match(/[\d,]+\.?\d*/);
        if (match) {
          const amount = parseFloat(match[0].replace(/,/g, ''));
          return Math.round(amount * 100); // Convert to cents
        }
      }
    }
    
    // Fallback: try to get from checkout object
    if (window.Shopify && window.Shopify.checkout) {
      const total = window.Shopify.checkout.total_price;
      if (total) {
        return Math.round(total / 100);
      }
    }
    
    console.warn('SumUp: Could not find checkout total');
    return null;
  }
  
  // Get currency
  function getCurrency() {
    if (window.Shopify && window.Shopify.checkout) {
      return window.Shopify.checkout.currency || 'EUR';
    }
    return 'EUR';
  }
  
  // Get order ID if available
  function getOrderId() {
    if (window.Shopify && window.Shopify.checkout) {
      return window.Shopify.checkout.order_id || null;
    }
    return null;
  }
  
  // Get return URL
  function getReturnUrl() {
    const hostname = window.location.hostname;
    const protocol = window.location.protocol;
    return `${protocol}//${hostname}/checkout/thank_you`;
  }
  
  // Show error message
  function showError(message) {
    const errorDiv = document.getElementById('sumup-error-message');
    if (errorDiv) {
      errorDiv.textContent = message;
      errorDiv.style.display = 'block';
      setTimeout(() => {
        errorDiv.style.display = 'none';
      }, 10000);
    }
    console.error('SumUp Error:', message);
  }
  
  // Hide error message
  function hideError() {
    const errorDiv = document.getElementById('sumup-error-message');
    if (errorDiv) {
      errorDiv.style.display = 'none';
    }
  }
  
  // Create checkout and mount widget
  async function initializePaymentWidget() {
    if (isProcessing) {
      return;
    }
    
    isProcessing = true;
    hideError();
    
    try {
      const amount = getCheckoutTotal();
      if (!amount || amount <= 0) {
        throw new Error('Could not determine checkout total. Please refresh and try again.');
      }
      
      const currency = getCurrency();
      const orderId = getOrderId();
      const returnUrl = getReturnUrl();
      
      console.log('SumUp: Creating checkout for widget:', {
        amount,
        currency,
        orderId,
        returnUrl
      });
      
      const payload = {
        amount: amount,
        currency: currency,
        description: orderId ? `Shopify Order #${orderId}` : 'Shopify Checkout Payment',
        order_id: orderId,
        redirect_url: returnUrl
      };
      
      const response = await fetch(`${BACKEND_URL}/create-checkout`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(payload)
      });
      
      const data = await response.json();
      
      if (!response.ok) {
        throw new Error(data.error || `Server error: ${response.status}`);
      }
      
      // Check for checkout_id in various possible fields
      const checkoutId = data.checkout_id || data.id || data.checkoutId;
      
      if (data.success && checkoutId) {
        console.log('SumUp: Checkout created, mounting widget with ID:', checkoutId);
        
        // Hide loading, show widget container
        const loadingDiv = document.getElementById('sumup-loading');
        if (loadingDiv) {
          loadingDiv.style.display = 'block';
        }
        
        // Ensure Shopify button is hidden
        hideShopifyCheckout();
        
        // Mount the Payment Widget
        sumupCardInstance = SumUpCard.mount({
          id: 'sumup-card',
          checkoutId: checkoutId,
          amount: (amount / 100).toFixed(2),
          currency: currency,
          locale: 'en-GB',
          showSubmitButton: true,
          showFooter: true,
          onResponse: function(type, body) {
            console.log('SumUp Widget Response - Type:', type);
            console.log('SumUp Widget Response - Body:', body);
            
            if (type === 'success') {
              // Payment successful
              console.log('âœ… Payment successful!');
              // Redirect to thank you page
              window.location.href = returnUrl;
            } else if (type === 'fail') {
              // Payment failed
              console.error('âŒ Payment failed:', body);
              showError('Payment failed. Please try again.');
              isProcessing = false;
            } else if (type === 'error') {
              // Error occurred
              console.error('âŒ Payment error:', body);
              showError('An error occurred during payment. Please try again.');
              isProcessing = false;
            } else if (type === 'invalid') {
              // Form validation errors
              console.warn('âš ï¸ Form validation errors');
            } else if (type === 'sent') {
              // Form submitted, processing
              console.log('â³ Payment processing...');
            } else if (type === 'auth-screen') {
              // 3D Secure authentication
              console.log('ðŸ” 3D Secure authentication required');
            }
          },
          onLoad: function() {
            console.log('âœ… SumUp Payment Widget loaded');
            isProcessing = false;
            // Hide loading message
            const loadingDiv = document.getElementById('sumup-loading');
            if (loadingDiv) {
              loadingDiv.style.display = 'none';
            }
            // Ensure Shopify button is still hidden
            hideShopifyCheckout();
          },
          onPaymentMethodsLoad: function(methods) {
            console.log('Payment methods available:', methods);
          }
        });
        
      } else {
        // Log the full response for debugging
        console.error('SumUp: Invalid response from backend:', data);
        throw new Error(data.error || 'Invalid response from server. Missing checkout_id.');
      }
      
    } catch (error) {
      console.error('SumUp: Error initializing widget:', error);
      
      let errorMessage = error.message || 'Failed to initialize payment. Please try again.';
      
      if (errorMessage.includes('Unknown client')) {
        errorMessage = 'Payment service configuration error. Please contact store support.';
      }
      
      showError(errorMessage);
      isProcessing = false;
    }
  }
  
  // Hide Shopify checkout button and prevent form submission
  function hideShopifyCheckout() {
    // Find and hide Shopify's checkout button
    const selectors = [
      'button[type="submit"]',
      'button[name="complete"]',
      '[data-complete-order-button]',
      '.step__footer__continue-btn',
      '.order-summary__section .btn',
      'button.btn--primary'
    ];
    
    selectors.forEach(selector => {
      const buttons = document.querySelectorAll(selector);
      buttons.forEach(button => {
        const text = (button.textContent || button.innerText || '').toLowerCase();
        if (text.includes('complete') || 
            text.includes('order') || 
            text.includes('voltooien') || 
            text.includes('afrekenen') ||
            text.includes('pay') ||
            text.includes('betalen')) {
          console.log('SumUp: Hiding Shopify checkout button');
          button.style.display = 'none';
          button.disabled = true;
        }
      });
    });
    
    // Prevent form submission
    const forms = document.querySelectorAll('form');
    forms.forEach(form => {
      // Remove existing listeners to avoid duplicates
      const newForm = form.cloneNode(true);
      form.parentNode.replaceChild(newForm, form);
      
      newForm.addEventListener('submit', function(e) {
        e.preventDefault();
        e.stopPropagation();
        e.stopImmediatePropagation();
        console.log('SumUp: Prevented Shopify form submission');
        return false;
      }, true);
    });
  }
  
  // Initialize when page loads
  function init() {
    console.log('SumUp: Initializing payment widget...');
    
    // Hide Shopify checkout immediately
    hideShopifyCheckout();
    // Keep hiding it periodically (in case it's added dynamically)
    setInterval(hideShopifyCheckout, 1000);
    
    // Wait for SumUp SDK to load
    if (typeof SumUpCard === 'undefined') {
      console.warn('SumUp: SDK not loaded yet, waiting...');
      setTimeout(init, 500);
      return;
    }
    
    // Wait for DOM to be ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function() {
        hideShopifyCheckout();
        setTimeout(initializePaymentWidget, 500);
      });
    } else {
      // Small delay to ensure checkout total is available
      setTimeout(initializePaymentWidget, 500);
    }
  }
  
  // Start initialization
  init();
  
})();
</script>

